{{- if eq .chezmoi.os "windows" -}}
$scriptDir = Join-Path $env:USERPROFILE '.custom_scripts'

$currentPath = [Environment]::GetEnvironmentVariable('Path', 'User')

if ($currentPath -notlike "*$scriptDir*") {
    $newPath = "$currentPath;$scriptDir"
    [Environment]::SetEnvironmentVariable('Path', $newPath, 'User')
    Write-Host "[OK] Added $scriptDir to user PATH"
} else {
    Write-Host "[SKIP] $scriptDir already in PATH"
}

try {
    $policy = Get-ExecutionPolicy -Scope CurrentUser
    if ($policy -eq 'Restricted') {
        Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned -Force
        Write-Host "[OK] Set ExecutionPolicy to RemoteSigned"
    }
} catch {
    Write-Host "[SKIP] ExecutionPolicy check skipped (not critical)"
}

$profilePath = $PROFILE.CurrentUserAllHosts
if (!(Test-Path $profilePath)) {
    New-Item -Path $profilePath -ItemType File -Force | Out-Null
}

$aliasBlock = @'

# === chezmoi custom scripts aliases ===
Set-Alias cc-update "$env:USERPROFILE\.custom_scripts\cc-update.ps1"
Set-Alias cc-claude "$env:USERPROFILE\.custom_scripts\run_claude_with_proxy.ps1"
# === end chezmoi aliases ===
'@

$profileContent = Get-Content $profilePath -Raw -ErrorAction SilentlyContinue
if ($profileContent -notlike '*chezmoi custom scripts*') {
    Add-Content -Path $profilePath -Value $aliasBlock
    Write-Host "[OK] Added aliases to $profilePath"
} else {
    Write-Host "[SKIP] Aliases already exist"
}
{{- else -}}
#!/bin/sh
echo "[SKIP] Not Windows"
{{- end -}}

